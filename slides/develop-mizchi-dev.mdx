---
title: next.js ã§è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹
---

# next.js ã§è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹

è‡ªåˆ†ã®ãƒ–ãƒ­ã‚°ã¨ã—ã¦ [mizchi.dev](https://mizchi.dev) ã‚’ä½œã£ãŸè©±

at [éš…ç”°å·\.js \#1\(ã‚ªãƒ³ãƒ©ã‚¤ãƒ³\) \- connpass](https://sumidagawajs.connpass.com/event/167632/)

---

## ä½•ã‚’ä½œã£ãŸã‹

ã“ã®ãƒ–ãƒ­ã‚°è‡ªèº«(mizchi.dev)ã€‚ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚‚çªè²«ã§è‡ªä½œ

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ [mizchi/dev](https://github.com/mizchi/dev)

---

## Lighthouse

![](https://i.gyazo.com/718543e55f8ca7c35e81bb67aa5cfa79.png)

---

## Full AMP

![](https://i.gyazo.com/bcc2d128064304c355d3c776d41a22a8.png)

---

## GA å¯¾å¿œ

![](https://gyazo.com/10b9063d30ff5fb73ec2cc5a3b824333.png)

---

## Git ã‹ã‚‰ç·¨é›†ãƒ’ã‚¹ãƒˆãƒªã®ç”Ÿæˆ

![](https://i.gyazo.com/13034861f0afceacf47ad8d8a09f239a.png)

---

## ã©ã‚“ãªãƒ–ãƒ­ã‚°ãŒã»ã—ã‹ã£ãŸã‹

- Lighthouse ã§æº€ç‚¹å‡ºã—ãŸã„
- æ™®é€šã® Markdown ã˜ã‚ƒã¤ã¾ã‚“ãªã„ã‹ã‚‰ MDX ã§æ›¸ããŸã„
- ã‚µãƒ¼ãƒãƒ¼ã®é‹ç”¨ã‚’ã—ãŸããªã„
- next.js ã®æœ€é©åŒ–ã«ä¹—ã‚ŠãŸã„

---

## ä½œã£ãŸ

- ã©ã†ã›å‹•ã‹ãªã„ã— CDN ä¸Šã§é™çš„ã‚µã‚¤ãƒˆ + Full AMP
- MDX ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’è‡ªä½œ (amdx)
- netlify + è²·ã£ãŸã¾ã¾å¿˜ã‚Œã¦ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³(mizchi.dev)
- `pages/*.tsx` ãŒå…¬é–‹ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ã€ãã®ã¾ã¾æ¡ç”¨

---

## (æœ¬éŸ³

- next.js ã§é™çš„ã‚µã‚¤ãƒˆé‹ç”¨ã®çŸ¥è¦‹ã‚’è²¯ã‚ãŸã„
- AMP ã®çŸ¥è¦‹ã‚’è²¯ã‚ãŸã„
- React ã§ã‚¬ã‚·ã‚¬ã‚·å‹•ãä½œä¾‹ã‚’ç½®ãå ´æ‰€ã‚’ã€è‡ªåˆ†ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ç”¨æ„ã—ãŸã„

---

## next.js ã® SSG + AMP ãƒ¢ãƒ¼ãƒ‰ã®æ¡ç”¨

```tsx
// pages/foo.tsx
export const config = { amp: true };
export default function Foo() {
  return <div>foo</div>;
}
```

- `amp: true` ã§å¸¸ã« amp ã‚’ç”Ÿæˆ
- AMP canonical ã¯å¸¸ã«è‡ªåˆ†è‡ªèº«ã‚’æŒ‡ã™(ã®ã‚’ next.js ãŒå‹æ‰‹ã«ã‚„ã£ã¦ãã‚Œã‚‹)

---

## AMP ã® plugin ã‚’è«¸ã€…çªã£è¾¼ã‚€

- `amp-social-share` ã§ twitter / facebook / hatena bookmark ã®ã‚·ã‚§ã‚¢ã«å¯¾å¿œ
- `amp-analytics` ã§ GoogleAnalytics å¯¾å¿œ
- rollup + preact + amp-script ã§ã€AMP ä¸Šã§å‹•çš„ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒä½œã‚Œã‚‹ã€‚å¾Œã§ä½•ã‹ã«ä½¿ã†

---

# AMP ç”¨ Markdown Compiler ã‚’ä½œã‚ã†ï¼

---

## AMP ç’°å¢ƒã® Markdown ã«æ±‚ã‚ã‚‰ã‚Œã‚‹ä»•æ§˜

- AMP ã®ä»•æ§˜ã‚’æº€ãŸã™
  - `img` => `amp-img` ã‹ã¤ã€ amp layout ä»•æ§˜ã‚’æº€ãŸã™å›ºå®šå¹…ã®è¦ç´ ã«
  - æ•°å¼ãƒ–ãƒ­ãƒƒã‚¯(`$$ ~ $$`) ã‚’ amp-mathml ã«å¤‰æ›
- ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ: **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§æ§‹æ–‡è§£æã§ããªã„** ã®ã§ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ¸ˆã¾ã›ã¦ãŠãå¿…è¦

---

## MDX ã«ã¤ã„ã¦

Markdown ä¸­ã§ import æ§‹æ–‡ãŒä½¿ãˆã‚‹ä»•æ§˜

```
# Hello, MDX

import Doc from "./doc";
<Doc />
```

Markdown ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã€åˆ¥ã® Markdown ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ã€React.Component
ã‚’å±•é–‹ã§ãã‚‹ã€‚
ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ã‚¿ãƒ¼ãªã©ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®éƒ½åˆã‹ã‚‰ã€`.mdx`æ‹¡å¼µå­ã‚’ãã®ã¾ã¾æ¡ç”¨ã—ãŸã„ã€‚

---

## AMDX: Accelarated MDX

- [mizchi/amdx: Accelarated MDX](https://github.com/mizchi/amdx)
- remark ãƒ™ãƒ¼ã‚¹ã§ `@mdx-js/mdx` ã‚’å…ƒã«æ‹¡å¼µ (ä¸­ã§ä½¿ã£ã¦ã‚‹ babel plugin ã¯ãã®ã¾ã¾ãªã®ã§ã€æ§‹æ–‡ã¯äº’æ›)
- refract(prismjs parser) ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
- +è‰²ã€… (toc, frontmatter ã‚„ WebWorker ã§å‹•ãã‚ˆã†ã«ç­‰)

---

## AMDXG: AMDX ã«ã‚ˆã‚‹é™çš„ã‚µã‚¤ãƒˆç”Ÿæˆãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ

- amdx-loader: amdx ã® webpack ç”¨ã®ãƒ­ãƒ¼ãƒ€ãƒ¼
- amdxg-components: ãƒ–ãƒ­ã‚°ç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé›†ã€‚ä½¿ã‚ãªãã¦ã‚‚ã„ã„
- amdxg-cli: ãƒšãƒ¼ã‚¸ã®é››å½¢ã‚„å„ç¨®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆç”¨ã® CLI
- amdxg-boilerplate: ãŸã ã®ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã€‚(æ³¨æ„: ã¾ã å®‰å®šã—ã¦ãªã„ã€‚é »ç¹ã«å¤‰ã‚ã‚‹)

---

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è§£æ

`docs/*.mdx` ã® frontmatter ã‚’è§£æ

```yaml
---
title: hello
created: 1589877769475
tags: [react, next, amp]
---

```

- ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ—¥ä»˜é †ã«ä¸¦ã¹ãŸ `gen/pages.json` ã‚’ç”Ÿæˆ
- ã‚¿ã‚°ã§é€†å¼•ãã™ã‚‹ç”¨ã® `gen/tagmap.json` ã‚’ç”Ÿæˆ
- git log ã®ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‹ã‚‰ `gen/*.history.json` ã‚’ç”Ÿæˆ

---

## Index

- `gen/pages.json` ã‹ã‚‰ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤º
- `gen/tagmap.json` ã‹ã‚‰ã‚¿ã‚°ä¸€è¦§ã‚’è¡¨ç¤º

---

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¡¨ç¤º

- `next.config.js` ã® `webpack` ã§ `.mdx` æ‹¡å¼µå­ã¯ amdx-loader (è‡ªä½œ) ã‚’é€šã™ã‚ˆã†ã«ã™ã‚‹
- next.js ã® danymic routing ã§ å¯¾å¿œã™ã‚‹ slug ã® component ã‚’å‹•çš„ã«è¿”ã™

```tsx
// pages/[slug].tsx
export const getStaticProps: GetStaticProps = async (props) => {
  const slug = props.params.slug;
  const { default: Doc, toc, frontmatter } = await import(
    `../docs/${slug}.mdx`
  );
  const { default: history } = await import(`../gen/${slug}.history.json`);
  return {
    props: {
      slug,
      toc,
      history,
      tags: frontmatter.tags || [],
      frontmatter: frontmatter || { title: slug, created: 0, tags: [] },
      html: ReactDOMServer.renderToStaticMarkup(<Doc amp />),
    } as Props,
  };
};
```

å¾Œã¯ amdxg-components ã§ç”¨æ„ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«çªã£è¾¼ã‚“ã§è¡¨ç¤º

---

## ã‚¿ã‚°ãƒšãƒ¼ã‚¸

- `gen/tagmap.json` ã‹ã‚‰ `/tags/react` ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤º

```tsx
// pages/tags/[tag].tsx
export function getStaticPaths() {
  const paths = Object.keys(tagmap).map((tag) => {
    return `/tags/${tag}`;
  });
  return {
    paths,
    fallback: false,
  };
}
export const getStaticProps: GetStaticProps = async (props) => {
  const tag = props.params.tag;
  return {
    props: {
      tagName: tag,
      pages: tagmap[tag as any],
    } as Props,
  };
};
```

---

## è‡ªåˆ†ã®ç’°å¢ƒã§éŠã¶

```bash
$ npx degit mizchi/mdxx/templates/blog myblog
$ cd myblog
$ git init && git commit -m "Init" # ç·¨é›†å±¥æ­´ç”Ÿæˆã« git history ã‚’ä½¿ã†
$ edit amdxg.config.js # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†

# æ›¸ã
$ npm i -g amdxg-cli
$ amdxg new:page new-article # docs/new-article.mdx ã«è¨˜äº‹ã®é››å½¢ã‚’ç”Ÿæˆ
$ npx run dev # localhost:3000 ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãªãŒã‚‰è¨˜äº‹ã‚’ç·¨é›†

# build / deploy

$ npx run build # out/ ã«é™çš„ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆ

# è¦: netlify account
$ npm i -g netlify-cli
$ netlify deploy -d out --prod
```

---

## ãƒ‡ãƒ¢

---

## ä»Šå¾Œã‚„ã‚‹ã“ã¨

- CSS ãŒé›‘
- amxd ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ (mdbuf.netlify.com ãƒ™ãƒ¼ã‚¹)
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µã‚¤ãƒˆ
- vercel ä¸Šã§ä»»æ„ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(CMS)ã‹ã‚‰ Incremental SSG ã™ã‚‹ä¾‹ã‚’ä½œã‚‹

[Incremental Static Regeneration ã§å®Ÿç¾ã™ã‚‹æ¬¡ä¸–ä»£ã®ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ \- mizdev](https://mizchi.dev/202005182044-awesome-next-issg)

---

## ãŠã‚ã‚Š

Google æ¤œç´¢çµæœã‹ã‚‰ã®é·ç§»ãŒçˆ†é€Ÿ ğŸ’ª

(CSS ãŒè‹¦æ‰‹ãªã®ã§åŠ©ã‘ã¦)
